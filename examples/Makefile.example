
# NOTE:  This Makefile  is setup  to be  used as  the Makefile  for each
# example  development.   It  makes  no  sense as  a  Makefile  for  the
# top-level `examples` directory.

############################################################################
#
#  Primary targets:
#    all           - the default target; synonym for 'coq'
#    coq           - builds all .vo files
#    doc           - synonym for 'documentation'
#    documentation - builds all html documentation
#    clean         - removes generated files
#
#  Other targets:
#    rebuild       - regenerates files from Ott language specifications
#
############################################################################

## Paths to executables. Do not include options here.
## Modify these to suit your Coq installation, if necessary.

LNGEN = stack exec lngen --
COQC = coqc
COQDEP = coqdep
COQDOC = coqdoc

## Include directories, one per line.

INCDIRS = \
	. \

## Name of the submakefile generated by coq_makefile
COQMKFILENAME=CoqSrc.mk

## Directory where generated HTML documentation should go.

DOCDIR = html

## List of files to be compiled and documented.

FILES = $(patsubst %.v,%,$(wildcard *.v))

## Lists calculated from the above.

VFILES   = $(foreach i, $(FILES), $(i).v)
VOFILES  = $(foreach i, $(FILES), $(i).vo)
INCFLAGS = $(foreach i, $(INCDIRS), -I $(i))

############################################################################

.PHONY: all clean coq dist doc documentation rebuild
.SUFFIXES: .v .vo

all: coq

coq:  $(COQMKFILENAME) $(VOFILES)
	make -f CoqSrc.mk

doc:
	+make documentation

documentation: $(DOCDIR) $(VOFILES)
	$(COQDOC) -g --quiet --noindex --html -d $(DOCDIR) $(VFILES)
	cp -f ../custom.css $(DOCDIR)/coqdoc.css

clean:
	rm -f *.vo *.glob *.cmi *.cmx *.o
	rm -rf $(DOCDIR) $(COQMKFILENAME) $(COQMKFILENAME).conf

realclean: clean
	rm -f $(OTT_SOURCE)_ott.v $(OTT_SOURSE)_inf.v

############################################################################

%.vo: %.v
	make -f $(COQMKFILENAME) $*.vo

$(DOCDIR):
	mkdir -p $(DOCDIR)


############################################################################

OTT_SOURCE = $(patsubst %.ott,%,$(wildcard *.ott))

rebuild:
	ott -i $(OTT_SOURCE).ott -o $(OTT_SOURCE)_ott.v -coq_lngen true -coq_expand_list_types true
	$(LNGEN) --coq $(OTT_SOURCE)_inf.v --coq-ott $(OTT_SOURCE)_ott  $(OTT_SOURCE).ott

$(COQMKFILENAME): Makefile $(shell ls *.v | grep -v _ott.v | grep -v _inf.v) 
	coq_makefile -arg '-w -variable-collision,-meta-collision,-require-in-module' -f _CoqProject -o $(COQMKFILENAME)

############################################################################

.depend: $(VFILES)
	$(COQDEP) -f _CoqProject > .depend

include .depend
